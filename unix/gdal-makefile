#
#  gdal.netcore package automation
#

include RID.opt 
include ../shared/GdalCore.opt 

# default targets on linux
TARGETS = proj gdal

all: $(TARGETS)
	@echo "$(PRE) Everything looks good. Linux libraries for GDAL is ready to packaging!"
	@echo "$(PRE) Configured libraries (vcpkg): $(VCPKG_REQUIRE_UNIX)"
	@echo "$(PRE) Configured libraries: $(TARGETS)"

pre_vcpkg:
	@echo "$(PRE) Precheck for VCPKG libraries installation..."
	$(MAKE) -f vcpkg-makefile
	@echo "$(PRE) VCPKG libraries precheck complete"

complete: pre_vcpkg all
	@exit 0

# forcing targets to execute	
force: $(addsuffix -force, $(TARGETS))
	@exit 0

# lower and uppercase funcs
UP  = $(shell echo '$*' | tr a-z A-Z)
LW = $(shell echo '$*' | tr A-Z a-z)

# add support for [-force] param
REP = $(shell echo '$(LW)' | sed "s/-force//g")

# target pretty output
TO = $(PRE) $(UP) |

# accepts any user params
% : 
ifneq ($(filter $(REP),$(TARGETS)),'')
	@echo "$(TO) trying to make stuff for => $(REP)"
	@if [ ! -d "$(BUILD_ROOT)/$(REP)-build" ] || [[ "$(LW)" == *"-force"* ]] ; then \
		$(MAKE) -f gdal-makefile  init_$(REP); \
		$(MAKE) -f gdal-makefile  configure_$(REP); \
		$(MAKE) -f gdal-makefile  build_$(REP); \
	else \
		echo "$(PRE) Build folder exists $(BUILD_ROOT)/$(REP)-build"; \
		echo "$(PRE) To rebuild add '$(LW)-force'"; \
	fi;
else
	@echo "$(PRE) Can not make $(REP)"
endif 

clone_%:
	@if [ ! -d "$($(UP)_ROOT)" ]; then \
		git clone $($(UP)_REPO) $($(UP)_ROOT); \
	fi;

clone_gdal:
	@if [ ! -d "$(BASE_SWIG_)" ]; then \
		git clone $(GDAL_REPO) $(GDAL_ROOT_BASE); \
	fi;

init_%: clone_%
	@echo "$(TO) Restoring $(LW) sources version to $($(UP)_COMMIT_VER)"
	@echo "$(TO) Checking for remote changes..." 
	@cd $($(UP)_ROOT) && git fetch
	@cd $($(UP)_ROOT) && git checkout -q $($(UP)_COMMIT_VER) --force
	@echo "$(TO) Resetting sources..." 
	@cd $($(UP)_ROOT) && git reset --hard
	@echo "$(TO) Cleaning the repo before compiling from scratch..." 
	@cd $($(UP)_ROOT) && $(GIT_CLEAN)
	@echo "$(TO) Sources restore complete"

configure_gdal:
	@echo "$(TO) GDAL Configuring..." 	
	(cd ${GDAL_ROOT} && cmake cmake ..
	@echo "$(TO) GDAL was configured!"
	
configure_proj: 
	@echo "$(TO) PROJ Configuring..."
	@cd $(BUILD_ROOT)/proj-build &&	cmake .. 
	@echo "$(TO) PROJ was configured!"
build_proj:
	@echo "$(TO) PROJ Building..."
	@cd $(BUILD_ROOT)/proj-build && $(MAKE) -j$(CORES)
	@echo "$(TO) PROJ was built!"

build_gdal:
	@echo "$(TO) GDAL Building..."
	@cd $(BUILD_ROOT)/gdal-build && $(MAKE) -j$(CORES)
	@echo "$(TO) GDAL was built!"

reset: reset_proj reset_gdal 
	@echo "$(TO) Reset ALL is complete" 

reset_%:
	@echo "$(TO) Resetting..."
	@cd $($(UP)_ROOT) && git checkout -q $($(UP)_COMMIT_VER) && git reset --hard && git clean -fqdx; 
	@echo "$(TO) Reset is complete"

.EXPORT_ALL_VARIABLES:
PKG_CONFIG_PATH=$(VCPKG_INSTALLED)/lib/pkgconfig:$(VCPKG_INSTALLED_DYNAMIC)/lib/pkgconfig
LD_LIBRARY_PATH=$$LD_LIBRARY_PATH:${VCPKG_INSTALLED_DYNAMIC}/lib